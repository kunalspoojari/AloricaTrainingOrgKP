/*************************************************************
@Name: APTS_AgreementTriggerHandler
@Author: Meera Kant, PS - Apttus
@CreateDate: 8/08/2016
@Description: Trigger on Agreement object 
@UsedBy: APTS_AgreementTrigger
******************************************************************
@ModifiedBy: 
@ChangeDescription: 
******************************************************************/
public with sharing class APTS_AgreementTriggerHandler {

    // To avoid recursive events
    public static Boolean onBeforeInsert = false; 
    public static Boolean onBeforeUpdate = false; 
    public static String docFormat = 'DOCX';
    public static String accessLevel = 'Read/Write';
    
    public static void onBeforeInsert(List<Apttus__APTS_Agreement__c> newRecsList) {   
       if(!onBeforeInsert)
        {
            onBeforeInsert = true;
            formatCallCenter(newRecsList);
        }
    }

     public static void onBeforeUpdate(List<Apttus__APTS_Agreement__c> newRecsList, Map<Id, Apttus__APTS_Agreement__c> oldAgreementsMap) {      
        if(!onBeforeUpdate)
        {
            onBeforeUpdate = true;
            autoGenerateDoc(newRecsList,oldAgreementsMap);
            formatCallCenter(newRecsList);
            updateStatus(newRecsList,oldAgreementsMap);
        }
    }

    public static void autoGenerateDoc(List<Apttus__APTS_Agreement__c> newRecsList, Map<Id, Apttus__APTS_Agreement__c> oldAgreementsMap){

        List<Apttus__APTS_Agreement__c> agmtList = new List<Apttus__APTS_Agreement__c>();
        Set<String> agrRecTypes = new Set<String>();
        List<Apttus__APTS_Template__c> templates = new List<Apttus__APTS_Template__c>();
        Map<Id,Id> agrTempMap = new Map<Id,Id>();
        //String generatedDocId; //String docFormat = 'DOC'; //String accessLevel = 'Read/Write';
        //String apiServerURL = System.Url.getSalesforceBaseUrl().toExternalForm() + '/services/Soap/u/14.0/' + UserInfo.getOrganizationId();
        for(Apttus__APTS_Agreement__c a : newRecsList){
            if ((a.Apttus__Status__c == 'Submitted Request') && (oldAgreementsMap.get(a.Id).Apttus__Status__c != 'Submitted Request') && (a.Apttus__Source__c == 'Alorica Paper')){
                agmtList.add(a);
                agrRecTypes.add(a.APTS_Record_Type_Name__c);
            }
        }
        if (agrRecTypes.size() > 0)
            templates = [SELECT Id, Apttus__Agreement_Types__c FROM Apttus__APTS_Template__c WHERE Apttus__Agreement_Types__c IN: agrRecTypes AND Apttus__IsActive__c=: true];
        for (Apttus__APTS_Agreement__c agr : agmtList)
            for (Apttus__APTS_Template__c temp: templates)
                if (temp.Apttus__Agreement_Types__c.contains(agr.APTS_Record_Type_Name__c))
                    agrTempMap.put(agr.Id, temp.Id);
        
        for (Id agrId : agrTempMap.keySet()){
            if(!Test.isRunningTest()) {futureAutoGenerateDoc(agrId, agrTempMap.get(agrId), UserInfo.getSessionId(), UserInfo.getOrganizationId(), System.Url.getSalesforceBaseUrl().toExternalForm());}
        }
        /*for(Apttus__APTS_Agreement__c a : newRecsList){
            if ((a.Apttus__Status__c == 'Submitted Request') && (a.Apttus__Source__c == 'Alorica Paper') && (oldAgreementsMap.get(a.Id).Apttus__Status__c != 'Submitted Request')){
                Apttus__APTS_Template__c myTemp = [SELECT Id FROM Apttus__APTS_Template__c WHERE Apttus__Agreement_Types__c =: a.APTS_Record_Type_Name__c AND Apttus__IsActive__c=: true LIMIT 1];
                futureAutoGenerateDoc(a.Id, myTemp.Id, UserInfo.getSessionId(), UserInfo.getOrganizationId(), System.Url.getSalesforceBaseUrl().toExternalForm()); } }*/
    }

    @future (callout=true)
    public static void futureAutoGenerateDoc(Id agrId, Id tempId, String sessId, String orgId, String uRL){
        
        String generatedDocId = Apttus.MergeWebService.generateDoc(tempId, agrId, accessLevel, docFormat, sessId, uRL + '/services/Soap/u/14.0/' + orgId);
    }
    
    public static void updateStatus(List<Apttus__APTS_Agreement__c> newRecsList, Map<Id, Apttus__APTS_Agreement__c> oldAgreementsMap){
    
        for(Apttus__APTS_Agreement__c a : newRecsList)
            if ((a.Apttus__Status__c == 'Other Party Signatures') && (a.Apttus__Status_Category__c == 'In Signatures') && (oldAgreementsMap.get(a.Id).Apttus__Status_Category__c == 'In Authoring')
                && ((oldAgreementsMap.get(a.Id).Apttus__Status__c == '')||(oldAgreementsMap.get(a.Id).Apttus__Status__c == NULL)))
            {
                a.Apttus__Status__c = 'Submitted Request';
                a.Apttus__Status_Category__c = 'In Authoring';
            }
    }
    
    public static void formatCallCenter(List<Apttus__APTS_Agreement__c> newRecsList){
    
        for (Apttus__APTS_Agreement__c a : newRecsList)
            if (a.Apts_Call_Center_Location__c != NULL)
              a.Apts_Call_Center_Formatted__c = a.Apts_Call_Center_Location__c.replace(';', ', ');
    }
}